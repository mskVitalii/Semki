services:
  # ----------------------------------- APPS
  semki-server:
    build: .
    container_name: semki-server
    develop:
      watch:
        - action: rebuild
          path: .
    env_file:
      - .env.production
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/api/v1/healthcheck"]
      interval: 15s
      timeout: 3s
      start_period: 1s
      retries: 3
    ports:
      - "8080:8080"
    networks:
      - semki_network
    depends_on:
      mongo:
        condition: service_healthy
      mailhog:
        condition: service_started

  embedder:
    image: mskkote/open-data-embedder:latest
    container_name: semki-embedder
    ports:
      - "8081:8080"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/healthz" ]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - semki_network

  web:
    container_name: semki-web
    build:
      context: ../client
      dockerfile: ../client/Dockerfile
    ports:
      - '80:80'
    environment:
      VITE_API_URL: http://semki-server:8080
    restart: unless-stopped


  # ----------------------------------- DATABASES
  mongo:
    image: mongo:latest
    container_name: semki-mongo
    healthcheck:
      test: mongosh --eval 'db.runCommand("ping").ok' --quiet
      interval: 15s
      retries: 3
      start_period: 15s
    ports:
      - 27017:27017
    volumes:
      - mongodb-data:/data/db
      - ./resources/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js
    networks:
      - semki_network
    env_file: .env.production
    command: ["--auth"]

  qdrant:
    image: qdrant/qdrant:v1.14.1
    container_name: semki-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - ./qdrant_data:/qdrant/storage
    environment:
      # gRPC configuration
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__ENABLE_TLS=false
      # Performance optimizations
      - QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS=0  # Use all available cores
      - QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS=2
      # Optional: increase payload index threshold for better performance
      - QDRANT__STORAGE__OPTIMIZERS__PAYLOAD_INDEX_THRESHOLD=20000
    env_file:
      - .env.production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "timeout", "1", "bash", "-c", "</dev/tcp/localhost/6333"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    networks:
      - semki_network

  redis:
    image: redis:7
    container_name: semki-redis
    ports:
      - "6379:6379"
    networks:
      - semki_network
    env_file: .env.production
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 10s
      timeout: 2s
      retries: 5
    command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD}" ]


  # ----------------------------------- INFRA
  # [MONITORING] Prometheus
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    container_name: semki-prometheus
    volumes:
      - ./resources/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - semki_network

  # [MONITORING] Grafana
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3030:3000"
    container_name: semki-grafana
    env_file: .env.production
    environment:
      - GF_FEATURE_TOGGLES_ENABLE=flameGraph
    volumes:
      - ./resources/grafana.yml:/etc/grafana/provisioning/datasources/datasources.yaml
      - ./resources/grafana-provisioning:/etc/grafana/provisioning
      - grafana:/var/lib/grafana
      - ./resources/grafana-dashboards:/var/lib/grafana/dashboards
    networks:
      - semki_network

  # [profiling] - Pyroscope
  pyroscope:
    image: pyroscope/pyroscope:latest
    deploy:
      restart_policy:
        condition: on-failure
    ports:
      - "4040:4040"
    container_name: semki-pyroscope
    environment:
      - PYROSCOPE_STORAGE_PATH=/var/lib/pyroscope
    command:
      - "server"
    networks:
      - semki_network

  # [TRACING] Jaeger
  jaeger:
    image: jaegertracing/all-in-one:latest
    networks:
      - semki_network
    env_file: .env.production
    ports:
      - "16686:16686"
      - "14269:14269"
      - "${JAEGER_PORT:-14268}:14268"
    container_name: semki-jaeger

  # [LOGGING] promtail
  promtail:
    image: grafana/promtail:3.2.1
    volumes:
      - ./resources/promtail-config.yaml:/etc/promtail/promtail.yaml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
    command: -config.file=/etc/promtail/promtail.yaml
    networks:
      - semki_network
    container_name: semki-promtail

  # [LOGGING] loki
  loki:
    image: grafana/loki:3.2.1
    ports:
      - "3100:3100"
    container_name: semki-loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./resources/loki-config.yaml:/etc/loki/local-config.yaml
      - loki-data:/loki
    networks:
      - semki_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s


  # [MAIL] Mailhog
  mailhog:
    image: mailhog/mailhog
    container_name: semki-mailhog
    ports:
      - "1025:1025"  # SMTP port
      - "8025:8025"  # Web UI port
    restart: unless-stopped
    networks:
      - semki_network

  # [MONITORING] MongoDB Exporter
  mongodb_exporter:
    image: percona/mongodb_exporter:0.40
    container_name: semki-mongodb-exporter
    restart: unless-stopped
    ports:
      - "9216:9216"
    environment:
      MONGODB_USER: ${MONGO_USER}
      MONGODB_PASSWORD: ${MONGO_PASSWORD}
    command:
      - '--mongodb.uri=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongo:${MONGO_PORT}/?authSource=${MONGO_DATABASE}'
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - semki_network
    env_file:
      - .env.production


# ----------------------------------- OTHER
networks:
  semki_network:
    driver: bridge

# Persistent data stores
volumes:
  mongodb-data:
  grafana:
  loki-data:
